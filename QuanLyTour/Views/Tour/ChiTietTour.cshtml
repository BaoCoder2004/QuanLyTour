@using X.PagedList.Mvc.Core
@model QuanLyTour.Models.DetailViewModel
@{
    ViewData["Title"] = "Thông tin tour";
    Layout = "~/Views/Shared/_Detail.cshtml";
}

<!--===== INNERPAGE-WRAPPER ====-->
<section class="innerpage-wrapper">
    <div id="hotel-details" class="innerpage-section-padding">
        <div class="container">
            <div class="row">

                <div class="col-xs-12 col-sm-12 col-md-3 side-bar left-side-bar">

                    <div class="side-bar-block booking-form-block">
                        <h2 class="selected-price">@Model.TourHienTai.TenTour<span></span></h2>
                        <h2 class="selected-price">@Model.TourHienTai.GiaTour.ToString("#,##") <span>VND | 1 người</span></h2>
                        @if (Context.Session.GetString("UserName") != null)
                        {
                            <div class="booking-form">
                                <h3>BOOKING</h3>
                                <p>Trải nghiệm ngay!</p>

                                @using (Html.BeginForm("DatTour", "Tour", new { maTour = Model.TourHienTai.MaTour }, FormMethod.Post))
                                {
                                    <div class="form-group">
                                        @Html.Hidden("MaNguoiDung", (int)ViewBag.MaNguoiDung)
                                    </div>
                                    <div class="form-group">
                                        @Html.TextBox("TenNguoiDung", (string)ViewBag.TenNguoiDung,
                                                 new { @class = "form-control", placeholder = "Tên khách hàng", required = "required" })
                                    </div>
                                    <div class="form-group">
                                        @Html.TextBox("SoDienThoai", (string)ViewBag.SoDienThoai,
                                                 new { @class = "form-control", placeholder = "Số điện thoại", required = "required" })
                                    </div>
                                    <div class="form-group">
                                        @Html.TextBox("DiaChi", (string)ViewBag.DiaChi,
                                                 new { @class = "form-control", placeholder = "Địa chỉ", required = "required" })
                                    </div>
                                    <div class="form-group">
                                        <label for="SoLuong">Số lượng:</label>
                                        <input type="number" name="SoLuong" id="SoLuong" class="form-control" min="1" value="1" />
                                    </div>
                                    <div class="form-group">
                                        @Html.TextBox("NgayDi", null, new { @class = "form-control dpd1", placeholder = "Chọn ngày", required = "required" })<i class="fa fa-calendar"></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="TongTien">Tổng tiền:</label>
                                        <input type="text" id="TongTien" class="form-control" readonly placeholder="Tổng tiền sẽ hiển thị ở đây" />
                                    </div>

                                    <!-- Thông tin thanh toán -->
                                    <h4>Thông tin thanh toán</h4>
                                    <div class="form-group">
                                        <label for="SoThe">Số thẻ thanh toán:</label>
                                        <input type="text" name="SoThe" id="SoThe" class="form-control" placeholder="Nhập số thẻ thanh toán" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="ChuThe">Chủ thẻ:</label>
                                        <input type="text" name="ChuThe" id="ChuThe" class="form-control" placeholder="Nhập tên chủ thẻ" required />
                                    </div>

                                    <script>
                                        var gia = @Model.TourHienTai.GiaTour;

                                        function tinhTongTien() {
                                            var soLuong = document.getElementById("SoLuong").value || 1;
                                            document.getElementById("TongTien").value = (gia * soLuong).toLocaleString('vi-VN') + " VND";
                                        }

                                        document.addEventListener("DOMContentLoaded", tinhTongTien);
                                        document.getElementById("SoLuong").addEventListener("input", tinhTongTien);
                                    </script>

                                    <div class="form-group right-icon">
                                        <select class="form-control">
                                            <option selected>@Model.TourHienTai.TenLoaiTour</option>
                                        </select>
                                        <i class="fa fa-angle-down"></i>
                                    </div>

                                    <button type="submit" class="btn btn-block btn-orange">Đặt và Thanh toán</button>
                                }


                            </div>

                            <!-- end booking-form -->
                        }
                        else
                        {
                            @using (Html.BeginForm("DangNhap", "Home", FormMethod.Get))
                            {
                                <form> 
                                    <button class="btn btn-block btn-orange">Đăng nhập để đặt tour</button>
                                </form>  
                            }
                        }
                    </div><!-- end side-bar-block -->
                </div><!-- end columns -->

                <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 content-side">
                    <div class="detail-slider">
                        <div class="feature-slider">
                            @if (!string.IsNullOrEmpty(Model.TourHienTai.HinhAnh1))
                            {
                                <div><img src="~/hinhanh/@Model.TourHienTai.HinhAnh1" class="img-responsive" alt="feature-img" /></div>
                            }
                            @if (!string.IsNullOrEmpty(Model.TourHienTai.HinhAnh2))
                            {
                                <div><img src="~/hinhanh/@Model.TourHienTai.HinhAnh2" class="img-responsive" alt="feature-img" /></div>
                            }
                            @if (!string.IsNullOrEmpty(Model.TourHienTai.HinhAnh3))
                            {
                                <div><img src="~/hinhanh/@Model.TourHienTai.HinhAnh3" class="img-responsive" alt="feature-img" /></div>
                            }
                        </div><!-- end feature-slider -->

                        <div class="feature-slider-nav">
                            @if (!string.IsNullOrEmpty(Model.TourHienTai.HinhAnh1))
                            {
                                <div><img src="~/hinhanh/@Model.TourHienTai.HinhAnh1" class="img-responsive" alt="feature-thumb" /></div>
                            }
                            @if (!string.IsNullOrEmpty(Model.TourHienTai.HinhAnh2))
                            {
                                <div><img src="~/hinhanh/@Model.TourHienTai.HinhAnh2" class="img-responsive" alt="feature-thumb" /></div>
                            }
                            @if (!string.IsNullOrEmpty(Model.TourHienTai.HinhAnh3))
                            {
                                <div><img src="~/hinhanh/@Model.TourHienTai.HinhAnh3" class="img-responsive" alt="feature-thumb" /></div>
                            }
                        </div><!-- end feature-slider-nav -->
                    </div><!-- end detail-slider -->
                    </br>
                    </br>
                    <div class="available-blocks" id="available-rooms">
                        <h2>Mô tả chi tiết Tour</h2>
                        <p>@Html.Raw(Model.TourHienTai.MoTa == null ? "" : Model.TourHienTai.MoTa.Replace("\n", "<br>").Replace("\r", ""))</p>
                    </div>
                    <div class="available-blocks" id="available-rooms">
                        <h2>Lịch trình của Tour</h2>
                        <p>@Html.Raw(Model.TourHienTai.LichTrinh == null ? "" : Model.TourHienTai.LichTrinh.Replace("\n", "<br>").Replace("\r", ""))</p>
                    </div>
                    <div class="available-blocks" id="available-rooms">
                        <h2>Các Tour @Model.TourHienTai.TenLoaiTour gợi ý:</h2>

                        @foreach (var item in Model.TourTuongTu)
                        {
                            <div class="list-block main-block room-block">
                                <div class="list-content">
                                    <div class="main-img list-img room-img">
                                        <a href="#">
                                            <img src="~/hinhanh/@item.HinhAnh1" class="img-responsive" alt="room-img" />
                                        </a>
                                        <div class="main-mask">
                                            <ul class="list-unstyled list-inline offer-price-1">
                                                <li class="price">@item.GiaTour.ToString("#,##") VND<span class="divider">|</span><span class="pkg">1 người</span></li>
                                            </ul>
                                        </div><!-- end main-mask -->
                                    </div><!-- end room-img -->
                                    <div class="list-info room-info">
                                        <h3 class="block-title"><a href="@Url.Action("ChiTietTour","Tour",new { maTour = item.MaTour, maLoai = item.MaLoaiTour })">@item.TenTour</a></h3>
                                        <p class="block-minor">@item.TenTour</p>
                                        <p></p>
                                        <a href="@Url.Action("ChiTietTour","Tour",new { maTour = item.MaTour,maLoai = item.MaLoaiTour })" class="btn btn-orange btn-lg">Xem thêm</a>
                                    </div><!-- end room-info -->
                                </div>

                                <!-- end list-content -->
                            </div>
                            <!-- end room-block -->
                        }
                    </div><!-- end available-rooms -->
                    <div class="text-center">
                       @Html.PagedListPager(Model.TourTuongTu, page => Url.Action("DanhMucTour", new { page, maPhong = Model.TourHienTai.MaTour }))
                    </div>
                    <!-- end pages -->
                </div><!-- end columns -->
            </div><!-- end row -->
        </div><!-- end container -->
    </div><!-- end hotel-details -->
</section><!-- end innerpage-wrapper -->

<div class="container">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <!-- Review Container -->
            <div class="review-container">
                <!-- Review Header -->
                <div class="review-header">
                    <h2 class="review-title">Đánh giá từ khách hàng</h2>
                    <div class="review-summary">
                        <div class="review-rating-big">4.5</div>
                        <div class="review-rating-details">
                            <div class="row">
                                <div class="col-xs-2">5 sao</div>
                                <div class="col-xs-8">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 75%"></div>
                                    </div>
                                </div>
                                <div class="col-xs-2 text-right">75%</div>
                            </div>
                            <div class="row">
                                <div class="col-xs-2">4 sao</div>
                                <div class="col-xs-8">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 18%"></div>
                                    </div>
                                </div>
                                <div class="col-xs-2 text-right">18%</div>
                            </div>
                            <div class="row">
                                <div class="col-xs-2">3 sao</div>
                                <div class="col-xs-8">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 5%"></div>
                                    </div>
                                </div>
                                <div class="col-xs-2 text-right">5%</div>
                            </div>
                            <div class="row">
                                <div class="col-xs-2">2 sao</div>
                                <div class="col-xs-8">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 1%"></div>
                                    </div>
                                </div>
                                <div class="col-xs-2 text-right">1%</div>
                            </div>
                            <div class="row">
                                <div class="col-xs-2">1 sao</div>
                                <div class="col-xs-8">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 1%"></div>
                                    </div>
                                </div>
                                <div class="col-xs-2 text-right">1%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Form -->
                <div class="review-form">
                    <h4>Đánh giá của bạn</h4>
                    <div class="rating-stars">
                        <i class="fa fa-star"></i>
                        <i class="fa fa-star"></i>
                        <i class="fa fa-star"></i>
                        <i class="fa fa-star"></i>
                        <i class="fa fa-star-o"></i>
                    </div>
                    @using (Html.BeginForm("SubmitReview", "Reviews", FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
                        <div class="form-group">
                            <label for="reviewTitle">Tiêu đề:</label>
                            <input type="text" class="form-control" id="reviewTitle" name="Title" placeholder="Nhập tiêu đề đánh giá" required>
                        </div>
                        <div class="form-group">
                            <label for="reviewContent">Nội dung:</label>
                            <textarea class="form-control" id="reviewContent" name="Content" rows="4" placeholder="Chia sẻ trải nghiệm của bạn..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Hình ảnh:</label>
                            <input type="file" id="reviewImages" name="Images" multiple>
                            <p class="help-block">Tối đa 5 hình ảnh (PNG, JPG)</p>
                        </div>
                        <input type="hidden" id="ratingValue" name="Rating" value="4">
                        <button type="submit" class="btn-form btn-primary">Gửi đánh giá</button>
                    }
                </div>

                <!-- Sort Options -->
                <div class="sort-options">
                    <label>Sắp xếp theo:</label>
                    @Html.DropDownList("SortOption", new SelectList(new[] { "Mới nhất", "Đánh giá cao nhất", "Đánh giá thấp nhất" }), new { @class = "form-control-sm", @onchange = "document.location.href = '/Reviews/Index?sort=' + this.value" })
                </div>

                <!-- Review List -->
                <div class="review-list">
                    <!-- Review Item 1 -->
                    <div class="review-item">
                        <div class="review-item-header">
                            <div class="review-item-user">Nguyễn Văn A</div>
                            <div class="review-item-date">20/03/2025</div>
                        </div>
                        <div class="review-item-rating">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                        </div>
                        <div class="review-item-content">
                            <strong>Dịch vụ tuyệt vời!</strong>
                            <p>Khách sạn rất tốt, phòng sạch sẽ và hiện đại. Nhân viên thân thiện và nhiệt tình. Vị trí thuận tiện để đi tham quan các điểm du lịch. Tôi sẽ quay lại vào lần sau.</p>
                        </div>
                        <div class="review-item-images">
                            <div class="review-item-image">
                                <img src="@Url.Content("~/Content/Images/reviews/review1-1.jpg")" alt="Hình ảnh đánh giá">
                            </div>
                            <div class="review-item-image">
                                <img src="@Url.Content("~/Content/Images/reviews/review1-2.jpg")" alt="Hình ảnh đánh giá">
                            </div>
                        </div>
                        <div class="review-item-actions">
                            <a href="javascript:void(0);" class="like-review" data-review-id="1"><i class="fa fa-thumbs-up"></i> Hữu ích (<span class="like-count">8</span>)</a>
                            <a href="javascript:void(0);" class="reply-review" data-review-id="1"><i class="fa fa-comment"></i> Phản hồi</a>
                        </div>
                    </div>

                    <!-- Review Item 2 -->
                    <div class="review-item">
                        <div class="review-item-header">
                            <div class="review-item-user">Trần Thị B</div>
                            <div class="review-item-date">15/03/2025</div>
                        </div>
                        <div class="review-item-rating">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        <div class="review-item-content">
                            <strong>Trải nghiệm tốt</strong>
                            <p>Phòng đẹp và thoáng mát. Bữa sáng đa dạng và ngon miệng. Chỉ tiếc là hồ bơi hơi nhỏ và đông người. Tổng thể vẫn rất hài lòng với dịch vụ.</p>
                        </div>
                        <div class="review-item-actions">
                            <a href="javascript:void(0);" class="like-review" data-review-id="2"><i class="fa fa-thumbs-up"></i> Hữu ích (<span class="like-count">3</span>)</a>
                            <a href="javascript:void(0);" class="reply-review" data-review-id="2"><i class="fa fa-comment"></i> Phản hồi</a>
                        </div>
                    </div>

                    <!-- Review Item 3 -->
                    <div class="review-item">
                        <div class="review-item-header">
                            <div class="review-item-user">Lê Văn C</div>
                            <div class="review-item-date">10/03/2025</div>
                        </div>
                        <div class="review-item-rating">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        <div class="review-item-content">
                            <strong>Bình thường</strong>
                            <p>Vị trí khách sạn thuận tiện nhưng phòng hơi ồn vào buổi tối. Nhân viên phục vụ tốt nhưng đôi khi hơi chậm. Giá cả hợp lý cho chất lượng.</p>
                        </div>
                        <div class="review-item-images">
                            <div class="review-item-image">
                                <img src="@Url.Content("~/Content/Images/reviews/review3-1.jpg")" alt="Hình ảnh đánh giá">
                            </div>
                        </div>
                        <div class="review-item-actions">
                            <a href="javascript:void(0);" class="like-review" data-review-id="3"><i class="fa fa-thumbs-up"></i> Hữu ích (<span class="like-count">1</span>)</a>
                            <a href="javascript:void(0);" class="reply-review" data-review-id="3"><i class="fa fa-comment"></i> Phản hồi</a>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation" class="text-center">
                    <ul class="pagination center-block" style="display: flex; justify-content: center; margin: 0 auto;">
                        <li>
                            <a href="@Url.Action("Index", "Reviews", new { page = 1, sort = ViewBag.CurrentSort })" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="active"><a href="@Url.Action("Index", "Reviews", new { page = 1, sort = ViewBag.CurrentSort })">1</a></li>
                        <li><a href="@Url.Action("Index", "Reviews", new { page = 2, sort = ViewBag.CurrentSort })">2</a></li>
                        <li><a href="@Url.Action("Index", "Reviews", new { page = 3, sort = ViewBag.CurrentSort })">3</a></li>
                        <li><a href="@Url.Action("Index", "Reviews", new { page = 4, sort = ViewBag.CurrentSort })">4</a></li>
                        <li><a href="@Url.Action("Index", "Reviews", new { page = 5, sort = ViewBag.CurrentSort })">5</a></li>
                        <li>
                            <a href="@Url.Action("Index", "Reviews", new { page = 2, sort = ViewBag.CurrentSort })" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
                $(document).ready(function() {
            // Xử lý khi người dùng click vào sao đánh giá
            $('.rating-stars i').click(function() {
                var index = $(this).index();

                // Reset tất cả các sao về trạng thái không chọn
                $('.rating-stars i').removeClass('fa-star').addClass('fa-star-o');

                // Đánh dấu các sao đã chọn
                for (var i = 0; i <= index; i++) {
                    $('.rating-stars i').eq(i).removeClass('fa-star-o').addClass('fa-star');
                }

                // Cập nhật giá trị rating
                $('#ratingValue').val(index + 1);
            });

            // Xử lý sự kiện click vào nút "Hữu ích"
            $('.like-review').click(function(e) {
                e.preventDefault();
                var $this = $(this);
                var reviewId = $this.data('review-id');
                var likeCountElement = $this.find('.like-count');
                var currentLikes = parseInt(likeCountElement.text());

                // Kiểm tra nếu chưa like
                if (!$this.hasClass('liked')) {
                    // Hiển thị hiệu ứng khi click
                    $this.addClass('liked');

                    // Cập nhật trực tiếp giao diện trước
                    likeCountElement.text(currentLikes + 1);

                    // Gửi yêu cầu AJAX để cập nhật số lượt thích
                    $.ajax({
                        url: '/Reviews/LikeReview',
                        type: 'POST',
                        data: { id: reviewId },
                        success: function(result) {
                            // Đã cập nhật số lượt thích lên server thành công
                            console.log('Đã thích đánh giá #' + reviewId);
                        },
                        error: function(xhr, status, error) {
                            // Xử lý lỗi: hoàn tác thay đổi trên UI
                            console.log('Đã xảy ra lỗi khi thích đánh giá: ' + error);
                            $this.removeClass('liked');
                            likeCountElement.text(currentLikes);
                        }
                    });
                }
            });

            // Xử lý sự kiện click vào nút "Phản hồi"
            $('.reply-review').click(function(e) {
                e.preventDefault();
                var reviewId = $(this).data('review-id');
                var reviewItem = $(this).closest('.review-item');

                // Đóng các form phản hồi khác nếu có
                $('.reply-form').remove();

                // Kiểm tra xem form phản hồi đã tồn tại chưa
                if (reviewItem.find('.reply-form').length === 0) {
                    // Tạo form phản hồi
                    var replyForm = $('<div class="reply-form mt-2">' +
                        '<textarea class="form-control" rows="2" placeholder="Viết phản hồi của bạn..."></textarea>' +
                        '<div class="reply-btn mt-2">' +
                        '<button class="btn btn-send btn-sm btn-primary submit-reply" data-review-id="' + reviewId + '">Gửi</button> ' +
                        '<button class="btn btn-cancel btn-sm btn-default cancel-reply">Hủy</button>' +
                        '</div>' +
                        '</div>');

                    // Thêm form vào cuối review item
                    reviewItem.append(replyForm);

                    // Focus vào textarea
                    replyForm.find('textarea').focus();

                    // Xử lý sự kiện khi nhấn nút Hủy
                    replyForm.find('.cancel-reply').click(function() {
                        replyForm.remove();
                    });

                    // Xử lý sự kiện khi nhấn nút Gửi
                    replyForm.find('.submit-reply').click(function() {
                        var replyContent = replyForm.find('textarea').val();
                        if (replyContent.trim() !== '') {
                            // Hiển thị loading
                            var submitBtn = $(this);
                            submitBtn.prop('disabled', true).text('Đang gửi...');

                            // Gửi phản hồi bằng AJAX
                            $.ajax({
                                url: '/Reviews/SubmitReply',
                                type: 'POST',
                                data: {
                                    reviewId: reviewId,
                                    content: replyContent
                                },
                                success: function(result) {
                                    // Hiển thị phản hồi mới
                                    var newReply = $('<div class="review-reply">' +
                                        '<div class="review-reply-header">' +
                                        '<div class="review-reply-user">Bạn</div>' +
                                        '<div class="review-reply-date">Vừa xong</div>' +
                                        '</div>' +
                                        '<div class="review-reply-content">' + replyContent + '</div>' +
                                        '</div>');

                                    // Thêm phản hồi vào trước form
                                    replyForm.before(newReply);

                                    // Xóa form
                                    replyForm.remove();
                                },
                                error: function(xhr, status, error) {
                                    // Xử lý lỗi
                                    alert('Đã xảy ra lỗi khi gửi phản hồi: ' + error);
                                    submitBtn.prop('disabled', false).text('Gửi');
                                }
                            });
                        } else {
                            // Báo lỗi nếu nội dung trống
                            alert('Vui lòng nhập nội dung phản hồi.');
                        }
                    });
                }
            });
        });
    </script>
}
